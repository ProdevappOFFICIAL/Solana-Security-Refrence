name: Test All Vulnerability Examples

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  SOLANA_VERSION: 1.18.26
  ANCHOR_VERSION: 0.30.1

jobs:
  simple-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm install
    
    - name: Run simple educational tests
      run: npm test
    
    - name: Verify all examples have required files
      run: |
        for example in 01_missing_account_validation 02_authority_check_failure 03_unsafe_cpi 04_arithmetic_overflow 05_reinitialization_attack; do
          echo "Checking $example..."
          test -f "$example/README.md" || (echo "Missing $example/README.md" && exit 1)
          test -f "$example/EXPLOIT.md" || (echo "Missing $example/EXPLOIT.md" && exit 1)
          test -f "$example/package.json" || (echo "Missing $example/package.json" && exit 1)
          test -f "$example/Anchor.toml" || (echo "Missing $example/Anchor.toml" && exit 1)
          test -d "$example/programs" || (echo "Missing $example/programs directory" && exit 1)
          test -d "$example/tests" || (echo "Missing $example/tests directory" && exit 1)
        done
        echo "âœ… All required files present"

  full-test:
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      matrix:
        example: [
          "01_missing_account_validation",
          "02_authority_check_failure", 
          "03_unsafe_cpi",
          "04_arithmetic_overflow",
          "05_reinitialization_attack"
        ]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Cache Solana CLI
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/solana
          ~/.local/share/solana
        key: solana-${{ env.SOLANA_VERSION }}-${{ runner.os }}
    
    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
    
    - name: Install Solana CLI
      run: |
        sh -c "$(curl -sSfL https://release.solana.com/v${{ env.SOLANA_VERSION }}/install)"
        echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        solana --version
    
    - name: Install Anchor CLI
      run: |
        cargo install --git https://github.com/coral-xyz/anchor avm --locked --force
        avm install ${{ env.ANCHOR_VERSION }}
        avm use ${{ env.ANCHOR_VERSION }}
        echo "$HOME/.avm/bin" >> $GITHUB_PATH
    
    - name: Setup Solana config
      run: |
        solana config set --url localhost
        solana-keygen new --no-bip39-passphrase --force
    
    - name: Install Node.js dependencies
      working-directory: ${{ matrix.example }}
      run: |
        npm install
    
    - name: Build example
      working-directory: ${{ matrix.example }}
      run: |
        anchor build
    
    - name: Generate types
      working-directory: ${{ matrix.example }}
      run: |
        anchor build --idl target/idl
    
    - name: Run unit tests (Rust)
      working-directory: ${{ matrix.example }}
      run: |
        cargo test --manifest-path programs/*/Cargo.toml
      continue-on-error: true
    
    - name: Run integration tests (TypeScript)
      working-directory: ${{ matrix.example }}
      run: |
        npm test
      continue-on-error: true

  lint:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
    
    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-lint-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Check formatting
      run: |
        for example in 01_missing_account_validation 02_authority_check_failure 03_unsafe_cpi 04_arithmetic_overflow 05_reinitialization_attack; do
          if [ -d "$example/programs" ]; then
            find "$example/programs" -name "*.rs" -exec cargo fmt --check --manifest-path "$example/programs/*/Cargo.toml" {} \; || true
          fi
        done
    
    - name: Run clippy
      run: |
        for example in 01_missing_account_validation 02_authority_check_failure 03_unsafe_cpi 04_arithmetic_overflow 05_reinitialization_attack; do
          if [ -d "$example" ]; then
            cd "$example"
            if [ -f "programs/*/Cargo.toml" ]; then
              cargo clippy --manifest-path programs/*/Cargo.toml --all-targets --all-features -- -D warnings || true
            fi
            cd ..
          fi
        done

  documentation:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Check documentation completeness
      run: |
        # Check main documentation files exist
        test -f README.md || (echo "Missing README.md" && exit 1)
        test -f CONTRIBUTING.md || (echo "Missing CONTRIBUTING.md" && exit 1)
        test -f DEEP_DIVE.md || (echo "Missing DEEP_DIVE.md" && exit 1)
        
        # Check each example has required documentation
        for example in 01_missing_account_validation 02_authority_check_failure 03_unsafe_cpi 04_arithmetic_overflow 05_reinitialization_attack; do
          if [ -d "$example" ]; then
            test -f "$example/README.md" || (echo "Missing $example/README.md" && exit 1)
            test -f "$example/EXPLOIT.md" || (echo "Missing $example/EXPLOIT.md" && exit 1)
          fi
        done
        
        echo "All required documentation files are present"